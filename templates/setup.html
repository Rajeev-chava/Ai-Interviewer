{% extends "base.html" %}

{% block title %}Setup Your Interview - AI Interviewer{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto">
    <h1 class="text-3xl font-bold text-gray-800 mb-6">Setup Your Interview</h1>

    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <form id="interviewSetupForm" class="space-y-6">
            <!-- Job Title -->
            <div>
                <label for="jobTitle" class="block text-sm font-medium text-gray-700 mb-1">Job Title</label>
                <input type="text" id="jobTitle" name="jobTitle"
                       class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"
                       placeholder="e.g., Software Engineer, Product Manager, Data Scientist">
            </div>

            <!-- Experience Level -->
            <div>
                <label for="experienceLevel" class="block text-sm font-medium text-gray-700 mb-1">Experience Level</label>
                <select id="experienceLevel" name="experienceLevel"
                        class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="entry">Entry Level</option>
                    <option value="mid" selected>Mid Level</option>
                    <option value="senior">Senior Level</option>
                    <option value="leadership">Leadership</option>
                </select>
            </div>

            <!-- Experience in Years -->
            <div>
                <label for="experienceYears" class="block text-sm font-medium text-gray-700 mb-1">Experience in Years</label>
                <input type="number" id="experienceYears" name="experienceYears" min="0" max="50" value="3"
                       class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
            </div>

            <!-- Question Types -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Question Types</label>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="flex items-center">
                        <input type="checkbox" id="technical" name="questionTypes" value="technical" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded" checked>
                        <label for="technical" class="ml-2 text-sm text-gray-700">Technical</label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="behavioral" name="questionTypes" value="behavioral" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded" checked>
                        <label for="behavioral" class="ml-2 text-sm text-gray-700">Behavioral</label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="situational" name="questionTypes" value="situational" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded" checked>
                        <label for="situational" class="ml-2 text-sm text-gray-700">Situational</label>
                    </div>
                </div>
            </div>

            <!-- Number of Questions -->
            <div>
                <label for="numQuestions" class="block text-sm font-medium text-gray-700 mb-1">Number of Questions</label>
                <div class="flex items-center">
                    <input type="range" id="numQuestions" name="numQuestions" min="3" max="10" value="5"
                           class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    <span id="numQuestionsValue" class="ml-3 text-gray-700 font-medium">5</span>
                </div>
            </div>

            <!-- Video Recording Option -->
            <div>
                <div class="flex items-center">
                    <input type="checkbox" id="enableVideo" name="enableVideo" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded" checked>
                    <label for="enableVideo" class="ml-2 text-sm text-gray-700">Enable video recording (for body language analysis)</label>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="pt-4">
                <button type="submit"
                        class="w-full gradient-bg text-white px-6 py-3 rounded-lg font-medium text-lg shadow-md hover:shadow-lg transition transform hover:-translate-y-1">
                    Generate Interview
                </button>
            </div>
        </form>
    </div>

    <!-- Loading State -->
    <div id="loadingState" class="hidden bg-white rounded-lg shadow-md p-8 text-center">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-indigo-500 border-solid mx-auto mb-4"></div>
        <p class="text-gray-700 text-lg">Generating your personalized interview questions...</p>
    </div>

    <!-- Generated Questions Preview -->
    <div id="questionsPreview" class="hidden bg-white rounded-lg shadow-md p-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Your Interview Questions</h2>
        <div id="questionsList" class="space-y-4 mb-6">
            <!-- Questions will be inserted here by JavaScript -->
        </div>

        <div class="flex justify-end">
            <a href="#" id="startInterviewBtn"
               class="gradient-bg text-white px-6 py-3 rounded-lg font-medium text-lg shadow-md hover:shadow-lg transition transform hover:-translate-y-1">
                Start Interview
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Update number of questions display
    const numQuestionsSlider = document.getElementById('numQuestions');
    const numQuestionsValue = document.getElementById('numQuestionsValue');

    numQuestionsSlider.addEventListener('input', function() {
        numQuestionsValue.textContent = this.value;
    });

    // Handle form submission
    const setupForm = document.getElementById('interviewSetupForm');
    const loadingState = document.getElementById('loadingState');
    const questionsPreview = document.getElementById('questionsPreview');
    const questionsList = document.getElementById('questionsList');
    const startInterviewBtn = document.getElementById('startInterviewBtn');

    setupForm.addEventListener('submit', async function(e) {
        e.preventDefault();

        // Get form data
        const jobTitle = document.getElementById('jobTitle').value;
        const experienceLevel = document.getElementById('experienceLevel').value;
        const experienceYears = document.getElementById('experienceYears').value;
        const numQuestions = document.getElementById('numQuestions').value;
        const enableVideo = document.getElementById('enableVideo').checked;

        // Get selected question types
        const questionTypes = [];
        document.querySelectorAll('input[name="questionTypes"]:checked').forEach(checkbox => {
            questionTypes.push(checkbox.value);
        });

        // Validate form
        if (!jobTitle) {
            showNotification('Please enter a job title', 'error');
            return;
        }

        if (questionTypes.length === 0) {
            showNotification('Please select at least one question type', 'error');
            return;
        }

        // Show loading state
        setupForm.classList.add('hidden');
        loadingState.classList.remove('hidden');

        try {
            // Send request to server
            const response = await fetch('/setup', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    job_title: jobTitle,
                    experience_level: experienceLevel,
                    experience_years: parseInt(experienceYears),
                    question_types: questionTypes,
                    num_questions: parseInt(numQuestions),
                    enable_video: enableVideo
                }),
            });

            if (!response.ok) {
                throw new Error('Failed to generate questions');
            }

            const data = await response.json();

            // Display generated questions
            displayQuestions(data.questions);

            // Hide loading, show questions
            loadingState.classList.add('hidden');
            questionsPreview.classList.remove('hidden');

            // Log the questions for debugging
            console.log('Questions received from server:', data.questions);

            // The server now stores the questions in the session, no need to use sessionStorage

        } catch (error) {
            console.error('Error:', error);
            showNotification('Error generating questions. Please try again.', 'error');

            // Reset UI
            loadingState.classList.add('hidden');
            setupForm.classList.remove('hidden');
        }
    });

    function displayQuestions(questions) {
        // Clear previous questions
        questionsList.innerHTML = '';

        // Add each question to the list
        questions.forEach((question, index) => {
            const questionElement = document.createElement('div');
            questionElement.className = 'p-4 border border-gray-200 rounded-lg';

            const questionType = question.type.charAt(0).toUpperCase() + question.type.slice(1);

            questionElement.innerHTML = `
                <div class="flex items-start">
                    <span class="bg-indigo-100 text-indigo-800 text-xs font-medium px-2.5 py-0.5 rounded-full mr-2">
                        ${questionType}
                    </span>
                    <p class="text-gray-800">${index + 1}. ${question.question}</p>
                </div>
            `;

            questionsList.appendChild(questionElement);
        });
    }

    // Handle start interview button
    startInterviewBtn.addEventListener('click', function(e) {
        e.preventDefault();
        window.location.href = '/interview';
    });
</script>
{% endblock %}
