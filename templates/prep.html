{% extends "base.html" %}

{% block title %}Prep Interview - AI Interviewer{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <h1 class="text-3xl font-bold text-gray-800 mb-6">Prep Interview</h1>
    
    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="mb-6 p-4 rounded-lg {% if category == 'error' %}bg-red-100 text-red-700{% elif category == 'success' %}bg-green-100 text-green-700{% else %}bg-blue-100 text-blue-700{% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Generate Practice Questions</h2>
        <p class="text-gray-600 mb-6">Customize your practice interview to focus on the areas you want to improve.</p>
        
        <form id="prepForm" class="space-y-6">
            <!-- Job Title -->
            <div>
                <label for="job_title" class="block text-sm font-medium text-gray-700 mb-1">Job Title</label>
                <input type="text" id="job_title" name="job_title" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g. Software Engineer, Data Scientist, Product Manager">
            </div>
            
            <!-- Experience Level -->
            <div>
                <label for="experience_level" class="block text-sm font-medium text-gray-700 mb-1">Experience Level</label>
                <select id="experience_level" name="experience_level" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="entry">Entry Level</option>
                    <option value="mid">Mid Level</option>
                    <option value="senior">Senior Level</option>
                </select>
            </div>
            
            <!-- Years of Experience -->
            <div>
                <label for="experience_years" class="block text-sm font-medium text-gray-700 mb-1">Years of Experience</label>
                <input type="number" id="experience_years" name="experience_years" min="0" max="30" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g. 3">
            </div>
            
            <!-- Question Types -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Question Types</label>
                <div class="space-y-2">
                    <div class="flex items-center">
                        <input type="checkbox" id="technical" name="question_types" value="technical" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded" checked>
                        <label for="technical" class="ml-2 text-sm text-gray-700">Technical Questions</label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="behavioral" name="question_types" value="behavioral" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded" checked>
                        <label for="behavioral" class="ml-2 text-sm text-gray-700">Behavioral Questions</label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="situational" name="question_types" value="situational" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded" checked>
                        <label for="situational" class="ml-2 text-sm text-gray-700">Situational Questions</label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="coding" name="question_types" value="coding" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                        <label for="coding" class="ml-2 text-sm text-gray-700">Coding Questions</label>
                    </div>
                </div>
            </div>
            
            <!-- Coding Languages (only shown if coding is selected) -->
            <div id="codingLanguagesSection" class="hidden">
                <label class="block text-sm font-medium text-gray-700 mb-2">Coding Languages</label>
                <div class="grid grid-cols-2 gap-2">
                    <div class="flex items-center">
                        <input type="checkbox" id="python" name="coding_languages" value="python" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded" checked>
                        <label for="python" class="ml-2 text-sm text-gray-700">Python</label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="javascript" name="coding_languages" value="javascript" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                        <label for="javascript" class="ml-2 text-sm text-gray-700">JavaScript</label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="java" name="coding_languages" value="java" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                        <label for="java" class="ml-2 text-sm text-gray-700">Java</label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="csharp" name="coding_languages" value="csharp" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                        <label for="csharp" class="ml-2 text-sm text-gray-700">C#</label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="cpp" name="coding_languages" value="cpp" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                        <label for="cpp" class="ml-2 text-sm text-gray-700">C++</label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="sql" name="coding_languages" value="sql" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                        <label for="sql" class="ml-2 text-sm text-gray-700">SQL</label>
                    </div>
                </div>
            </div>
            
            <!-- Number of Questions -->
            <div>
                <label for="num_questions" class="block text-sm font-medium text-gray-700 mb-1">Number of Questions</label>
                <div class="flex items-center">
                    <input type="range" id="num_questions" name="num_questions" min="3" max="15" value="5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    <span id="num_questions_display" class="ml-3 text-gray-700 font-medium">5</span>
                </div>
            </div>
            
            <!-- Difficulty Level -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Difficulty Level</label>
                <div class="flex space-x-4">
                    <div class="flex items-center">
                        <input type="radio" id="easy" name="difficulty" value="easy" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                        <label for="easy" class="ml-2 text-sm text-gray-700">Easy</label>
                    </div>
                    <div class="flex items-center">
                        <input type="radio" id="medium" name="difficulty" value="medium" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300" checked>
                        <label for="medium" class="ml-2 text-sm text-gray-700">Medium</label>
                    </div>
                    <div class="flex items-center">
                        <input type="radio" id="hard" name="difficulty" value="hard" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                        <label for="hard" class="ml-2 text-sm text-gray-700">Hard</label>
                    </div>
                </div>
            </div>
            
            <!-- Generate Button -->
            <div class="pt-4">
                <button type="submit" id="generateBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-3 px-4 rounded-md transition">
                    Generate Practice Questions
                </button>
            </div>
        </form>
    </div>
    
    <!-- Loading State -->
    <div id="loadingState" class="bg-white rounded-lg shadow-md p-6 mb-8 text-center hidden">
        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-indigo-500 mx-auto mb-4"></div>
        <p class="text-gray-700">Generating your practice questions...</p>
        <p class="text-gray-500 text-sm mt-2">This may take a moment as our AI crafts personalized questions for you.</p>
    </div>
    
    <!-- Questions Preview -->
    <div id="questionsPreview" class="bg-white rounded-lg shadow-md p-6 mb-8 hidden">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold text-gray-800">Your Practice Questions</h2>
            <button id="startPracticeBtn" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-md transition">
                Start Practice
            </button>
        </div>
        
        <div id="questionsList" class="space-y-4">
            <!-- Questions will be populated here -->
        </div>
    </div>
</div>

<script>
    // DOM elements
    const prepForm = document.getElementById('prepForm');
    const codingCheckbox = document.getElementById('coding');
    const codingLanguagesSection = document.getElementById('codingLanguagesSection');
    const numQuestionsInput = document.getElementById('num_questions');
    const numQuestionsDisplay = document.getElementById('num_questions_display');
    const generateBtn = document.getElementById('generateBtn');
    const loadingState = document.getElementById('loadingState');
    const questionsPreview = document.getElementById('questionsPreview');
    const questionsList = document.getElementById('questionsList');
    const startPracticeBtn = document.getElementById('startPracticeBtn');
    
    // Show/hide coding languages section based on coding checkbox
    codingCheckbox.addEventListener('change', function() {
        if (this.checked) {
            codingLanguagesSection.classList.remove('hidden');
        } else {
            codingLanguagesSection.classList.add('hidden');
        }
    });
    
    // Update number of questions display
    numQuestionsInput.addEventListener('input', function() {
        numQuestionsDisplay.textContent = this.value;
    });
    
    // Form submission
    prepForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Get form data
        const formData = new FormData(prepForm);
        const questionTypes = Array.from(document.querySelectorAll('input[name="question_types"]:checked')).map(el => el.value);
        const codingLanguages = Array.from(document.querySelectorAll('input[name="coding_languages"]:checked')).map(el => el.value);
        
        // Create data object
        const data = {
            job_title: formData.get('job_title'),
            experience_level: formData.get('experience_level'),
            experience_years: parseInt(formData.get('experience_years') || '0'),
            question_types: questionTypes,
            coding_languages: codingLanguages,
            num_questions: parseInt(formData.get('num_questions')),
            difficulty: formData.get('difficulty')
        };
        
        // Show loading state
        prepForm.classList.add('hidden');
        loadingState.classList.remove('hidden');
        
        try {
            // Send request to server
            const response = await fetch('/api/generate-prep-questions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });
            
            if (!response.ok) {
                throw new Error('Failed to generate questions');
            }
            
            const result = await response.json();
            
            // Display questions
            displayQuestions(result.questions);
            
            // Hide loading, show questions
            loadingState.classList.add('hidden');
            questionsPreview.classList.remove('hidden');
            
        } catch (error) {
            console.error('Error:', error);
            
            // Show error message
            loadingState.classList.add('hidden');
            prepForm.classList.remove('hidden');
            
            // Show notification
            showNotification('Error generating questions. Please try again.', 'error');
        }
    });
    
    // Display questions
    function displayQuestions(questions) {
        questionsList.innerHTML = '';
        
        questions.forEach((question, index) => {
            const questionElement = document.createElement('div');
            questionElement.className = 'p-4 bg-gray-50 rounded-lg';
            
            let questionHTML = `
                <div class="flex items-start">
                    <span class="flex-shrink-0 w-6 h-6 bg-indigo-100 text-indigo-800 rounded-full flex items-center justify-center font-medium text-sm mr-3">${index + 1}</span>
                    <div>
                        <div class="flex items-center mb-1">
                            <span class="text-xs font-medium px-2 py-0.5 rounded-full ${getTypeColor(question.type)}">
                                ${question.type.charAt(0).toUpperCase() + question.type.slice(1)}
                            </span>
                            ${question.language ? `<span class="ml-2 text-xs font-medium px-2 py-0.5 rounded-full bg-gray-100 text-gray-800">${question.language}</span>` : ''}
                            ${question.difficulty ? `<span class="ml-2 text-xs font-medium px-2 py-0.5 rounded-full ${getDifficultyColor(question.difficulty)}">${question.difficulty}</span>` : ''}
                        </div>
                        <p class="text-gray-800 font-medium">${question.question}</p>
                    </div>
                </div>
            `;
            
            questionElement.innerHTML = questionHTML;
            questionsList.appendChild(questionElement);
        });
    }
    
    // Get color class for question type
    function getTypeColor(type) {
        switch (type.toLowerCase()) {
            case 'technical':
                return 'bg-blue-100 text-blue-800';
            case 'behavioral':
                return 'bg-green-100 text-green-800';
            case 'situational':
                return 'bg-purple-100 text-purple-800';
            case 'coding':
                return 'bg-yellow-100 text-yellow-800';
            default:
                return 'bg-gray-100 text-gray-800';
        }
    }
    
    // Get color class for difficulty
    function getDifficultyColor(difficulty) {
        switch (difficulty.toLowerCase()) {
            case 'easy':
                return 'bg-green-100 text-green-800';
            case 'medium':
                return 'bg-yellow-100 text-yellow-800';
            case 'hard':
                return 'bg-red-100 text-red-800';
            default:
                return 'bg-gray-100 text-gray-800';
        }
    }
    
    // Start practice button
    startPracticeBtn.addEventListener('click', function() {
        // Redirect to practice page
        window.location.href = '/practice';
    });
    
    // Show notification
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `fixed bottom-4 right-4 p-4 rounded-lg shadow-lg ${type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-green-500' : 'bg-indigo-500'} text-white max-w-md`;
        notification.innerHTML = `
            <div class="flex items-center">
                <i class="fas ${type === 'error' ? 'fa-exclamation-circle' : type === 'success' ? 'fa-check-circle' : 'fa-info-circle'} mr-3"></i>
                <p>${message}</p>
            </div>
        `;
        document.body.appendChild(notification);
        
        // Remove notification after 5 seconds
        setTimeout(() => {
            notification.classList.add('opacity-0', 'transition-opacity', 'duration-500');
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 500);
        }, 5000);
    }
</script>
{% endblock %}
